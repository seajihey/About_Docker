# ==============================================================================
# ğŸ“¦ BookShelf API - í†µí•© ìµœì í™” Dockerfile
# ==============================================================================
#
# ë¹Œë“œ: docker build -f Dockerfile.optimized -t bookshelf:optimized .
# ì‹¤í–‰: docker run -p 8080:8080 bookshelf:optimized
# 
# ì ìš©ëœ ìµœì í™” ì „ëµ:
#   1. Multi-stage Build   â†’ ë¹Œë“œ ë„êµ¬ì™€ ëŸ°íƒ€ì„ ë¶„ë¦¬
#   2. JRE Only            â†’ JDK ëŒ€ì‹  JRE ì‚¬ìš©
#   3. Alpine Linux        â†’ ê²½ëŸ‰ OS (~5MB)
#   4. Jlink Custom JRE    â†’ í•„ìš”í•œ Java ëª¨ë“ˆë§Œ í¬í•¨
#   5. Layer Caching       â†’ ë³€ê²½ ë¹ˆë„ìˆœ COPYë¡œ ìºì‹œ íš¨ìœ¨í™”
#   6. Security            â†’ non-root ì‚¬ìš©ì + COPY --chown
#
# ì˜ˆìƒ ì´ë¯¸ì§€ í¬ê¸°: ~130MB (ê¸°ì¡´ 650MB â†’ ì•½ 80% ê°ì†Œ)
#
# ==============================================================================

# ----- Stage 1: Build (Gradle) -----
FROM eclipse-temurin:17-jdk-alpine AS builder

WORKDIR /app

# Gradle Wrapper ë³µì‚¬ (ìºì‹œ - ê±°ì˜ ë³€ê²½ ì•ˆë¨)
COPY gradlew .
COPY gradle gradle
RUN chmod +x ./gradlew

# ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (ìºì‹œ - ê°€ë” ë³€ê²½)
COPY build.gradle settings.gradle ./
RUN ./gradlew dependencies --no-daemon || true

# ì†ŒìŠ¤ ë³µì‚¬ ë° ë¹Œë“œ (ìì£¼ ë³€ê²½)
COPY src src
RUN ./gradlew bootJar --no-daemon -x test

# ----- Stage 2: Custom JRE (Jlink) -----
FROM eclipse-temurin:17-jdk-alpine AS jre-builder

RUN $JAVA_HOME/bin/jlink \
    --add-modules java.base,java.logging,java.naming,java.desktop,java.management,java.security.jgss,java.instrument,java.sql,java.xml,jdk.unsupported,jdk.crypto.ec,jdk.crypto.cryptoki \
    --strip-debug \
    --no-man-pages \
    --no-header-files \
    --compress=2 \
    --output /custom-jre

# ----- Stage 3: Runtime (Alpine + Custom JRE) -----
FROM alpine:3.19

LABEL maintainer="BookShelf Team"
LABEL description="BookShelf API - Fully Optimized"
LABEL version="1.0.0"

# í•„ìˆ˜ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
RUN apk add --no-cache ca-certificates tzdata

# ì»¤ìŠ¤í…€ JRE ë³µì‚¬
COPY --from=jre-builder /custom-jre /opt/java
ENV JAVA_HOME=/opt/java
ENV PATH="$JAVA_HOME/bin:$PATH"

WORKDIR /app

# non-root ì‚¬ìš©ì ìƒì„±
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# JAR ë³µì‚¬ (ì†Œìœ ê¶Œ ë™ì‹œ ì„¤ì •ìœ¼ë¡œ ë ˆì´ì–´ ìµœì í™”)
COPY --chown=appuser:appgroup --from=builder /app/build/libs/*.jar app.jar

USER appuser

# JVM ì»¨í…Œì´ë„ˆ ìµœì í™” ì˜µì…˜
ENV JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]